services:
  # Main development environment with Python + R (NVIDIA GPU)
  dev:
    profiles: ["nvidia"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GPU_EXTRA: cu130
    container_name: cancer-biomarker-dev-nvidia
    volumes:
      - .:/workspace
      - uv-cache:/root/.cache/uv
      - renv-cache:/workspace/renv
    environment:
      - LLVM_CONFIG=/usr/bin/llvm-config-20
      - CMAKE_PREFIX_PATH=/usr/lib/llvm-20
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Main development environment with Python + R (AMD GPU - Native Linux)
  dev-amd:
    profiles: ["amd"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GPU_EXTRA: rocm
    container_name: cancer-biomarker-dev-amd
    volumes:
      - .:/workspace
      - uv-cache:/root/.cache/uv
      - renv-cache:/workspace/renv
    environment:
      - LLVM_CONFIG=/usr/bin/llvm-config-20
      - CMAKE_PREFIX_PATH=/usr/lib/llvm-20
    stdin_open: true
    tty: true
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video

  # Main development environment with Python + R (AMD GPU - WSL2)
  dev-amd-wsl:
    profiles: ["amd-wsl"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GPU_EXTRA: rocm
    container_name: cancer-biomarker-dev-amd-wsl
    volumes:
      - .:/workspace
      - uv-cache:/root/.cache/uv
      - renv-cache:/workspace/renv
      - /usr/lib/wsl:/usr/lib/wsl:ro  # WSL GPU libraries
    environment:
      - LLVM_CONFIG=/usr/bin/llvm-config-20
      - CMAKE_PREFIX_PATH=/usr/lib/llvm-20
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
    stdin_open: true
    tty: true
    devices:
      - /dev/dxg  # WSL2 DirectX Graphics device for GPU passthrough
    group_add:
      - video

volumes:
  uv-cache:
  renv-cache:
