apiVersion: batch/v1
kind: Job
metadata:
  name: oncolearn-data-downloader
  namespace: oncolearn
spec:
  # Run multiple parallel pods for distributed downloading
  parallelism: 4  # Number of pods running simultaneously
  completions: 4  # Total number of successful completions needed
  completionMode: Indexed  # Each pod gets a unique index (0 to completions-1)
  
  template:
    metadata:
      labels:
        app: oncolearn-downloader
        component: data-acquisition
    spec:
      restartPolicy: OnFailure
      
      # Init container to calculate cohort partition for this pod
      initContainers:
      - name: partition-calculator
        image: busybox:1.36
        command:
        - /bin/sh
        - -c
        - |
          #!/bin/sh
          # This script calculates which cohorts this pod should download
          # based on its JOB_COMPLETION_INDEX
          
          echo "Pod index: $JOB_COMPLETION_INDEX"
          echo "Total pods: $TOTAL_PODS"
          
          # Create partition info file
          mkdir -p /partition
          echo "$JOB_COMPLETION_INDEX" > /partition/pod_index
          echo "$TOTAL_PODS" > /partition/total_pods
          
          echo "Partition info created for pod $JOB_COMPLETION_INDEX of $TOTAL_PODS"
        env:
        - name: JOB_COMPLETION_INDEX
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['batch.kubernetes.io/job-completion-index']
        - name: TOTAL_PODS
          value: "4"  # Should match parallelism/completions
        volumeMounts:
        - name: partition-info
          mountPath: /partition
      
      containers:
      - name: downloader
        image: oncolearn:latest  # Build from your Dockerfile
        imagePullPolicy: IfNotPresent
        
        command:
        - /bin/bash
        - -c
        - |
          #!/bin/bash
          set -e
          
          # Read partition info
          POD_INDEX=$(cat /partition/pod_index)
          TOTAL_PODS=$(cat /partition/total_pods)
          
          echo "=========================================="
          echo "OncoLearn Data Downloader Pod $POD_INDEX"
          echo "=========================================="
          
          # Activate Python environment
          source /workspace/.venv/bin/activate
          
          # Split cohorts among pods
          IFS=',' read -ra ALL_COHORTS <<< "$XENA_COHORTS"
          COHORT_COUNT=${#ALL_COHORTS[@]}
          
          # Calculate cohorts per pod
          COHORTS_PER_POD=$((COHORT_COUNT / TOTAL_PODS))
          REMAINDER=$((COHORT_COUNT % TOTAL_PODS))
          
          # Calculate start index for this pod
          if [ $POD_INDEX -lt $REMAINDER ]; then
            START_IDX=$((POD_INDEX * (COHORTS_PER_POD + 1)))
            COUNT=$((COHORTS_PER_POD + 1))
          else
            START_IDX=$((POD_INDEX * COHORTS_PER_POD + REMAINDER))
            COUNT=$COHORTS_PER_POD
          fi
          
          # Extract cohorts for this pod
          MY_COHORTS=()
          for ((i=START_IDX; i<START_IDX+COUNT && i<COHORT_COUNT; i++)); do
            MY_COHORTS+=("${ALL_COHORTS[$i]}")
          done
          
          echo "This pod will download ${#MY_COHORTS[@]} cohorts:"
          printf '  - %s\n' "${MY_COHORTS[@]}"
          echo "=========================================="
          
          # Download assigned cohorts
          if [ ${#MY_COHORTS[@]} -gt 0 ]; then
            COHORT_LIST=$(IFS=','; echo "${MY_COHORTS[*]}")
            
            if [ "$DOWNLOAD_XENA" = "true" ]; then
              echo "Downloading from Xena Browser..."
              python3 /workspace/scripts/data/download.py \
                --xena \
                --cohorts "$COHORT_LIST" \
                --output "$XENA_DIR" \
                ${DATA_CATEGORY:+--category "$DATA_CATEGORY"}
            fi
            
            if [ "$DOWNLOAD_TCIA" = "true" ]; then
              echo "Downloading from TCIA..."
              python3 /workspace/scripts/data/download.py \
                --tcia \
                --cohorts "$COHORT_LIST" \
                --output "$TCIA_DIR" \
                ${DOWNLOAD_IMAGES:+--download-images}
            fi
          else
            echo "No cohorts assigned to this pod"
          fi
          
          echo "Download complete for pod $POD_INDEX"
        
        envFrom:
        - configMapRef:
            name: oncolearn-config
        
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: LLVM_CONFIG
          value: "/usr/bin/llvm-config-20"
        - name: CMAKE_PREFIX_PATH
          value: "/usr/lib/llvm-20"
        
        volumeMounts:
        - name: data
          mountPath: /data
        - name: workspace
          mountPath: /workspace
        - name: uv-cache
          mountPath: /root/.cache/uv
        - name: renv-cache
          mountPath: /workspace/renv
        - name: partition-info
          mountPath: /partition
        
        resources:
          requests:
            memory: "4Gi"
            cpu: "2"
          limits:
            memory: "8Gi"
            cpu: "4"
      
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: oncolearn-data-pvc
      - name: workspace
        emptyDir: {}  # Temporary workspace, populated from image
      - name: uv-cache
        persistentVolumeClaim:
          claimName: oncolearn-uv-cache-pvc
      - name: renv-cache
        persistentVolumeClaim:
          claimName: oncolearn-renv-cache-pvc
      - name: partition-info
        emptyDir: {}
