# Shared configuration using YAML anchors
x-common-config: &common-config
  env_file: .docker.env
  volumes:
    - .:/workspace
    - uv-cache:/root/.cache/uv
    - renv-cache:/workspace/renv
  environment:
    - LLVM_CONFIG=/usr/bin/llvm-config-20
    - CMAKE_PREFIX_PATH=/usr/lib/llvm-20
  stdin_open: true
  tty: true

x-common-build: &common-build
  context: .
  dockerfile: Dockerfile

services:
  # Main development environment with Python + R (NVIDIA GPU)
  dev-nvidia:
    <<: *common-config
    profiles: ["nvidia"]
    build:
      <<: *common-build
      args:
        GPU_EXTRA: cu130
    container_name: cancer-biomarker-dev-nvidia
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # Main development environment with Python + R (AMD GPU - Native Linux)
  dev-amd:
    <<: *common-config
    profiles: ["amd"]
    build:
      <<: *common-build
      args:
        GPU_EXTRA: rocm
    container_name: cancer-biomarker-dev-amd
    devices:
      - /dev/kfd
      - /dev/dri
    group_add:
      - video

  # Main development environment with Python + R (AMD GPU - WSL2)
  dev-amd-wsl:
    <<: *common-config
    profiles: ["amd-wsl"]
    build:
      <<: *common-build
      args:
        GPU_EXTRA: rocm
    container_name: cancer-biomarker-dev-amd-wsl
    volumes:
      - .:/workspace
      - uv-cache:/root/.cache/uv
      - renv-cache:/workspace/renv
      - /usr/lib/wsl:/usr/lib/wsl:ro  # WSL GPU libraries
    environment:
      - LLVM_CONFIG=/usr/bin/llvm-config-20
      - CMAKE_PREFIX_PATH=/usr/lib/llvm-20
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
    devices:
      - /dev/dxg  # WSL2 DirectX Graphics device for GPU passthrough
    group_add:
      - video

  # Main development environment with Python + R (CPU only)
  dev-cpu:
    <<: *common-config
    profiles: ["cpu"]
    build:
      <<: *common-build
      args:
        GPU_EXTRA: cpu
    container_name: cancer-biomarker-dev-cpu
    
volumes:
  uv-cache:
  renv-cache:
